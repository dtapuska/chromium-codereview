
<link rel="import" href="cr-diff-image.html">
<link rel="import" href="cr-patch-file-message.html">

<script src="../lib/highlight/highlight.pack.js"></script>

<polymer-element name="cr-diff" attributes="file active">
    <template>
        <link rel="stylesheet" href="cr-diff.css">
        <link rel="stylesheet" href="../lib/highlight/styles/default.css">
        <link rel="stylesheet" href="../lib/highlight/styles/googlecode.css">
        <div id="output"
            on-file-message-save="{{ saveDraft }}"
            on-file-message-discard="{{ discardDraft }}"
            on-file-message-cancel="{{ cancelDraft }}"
            on-tap="{{ handleTap }}">
        </div>
    </template>
    <script>
        Polymer("cr-diff", {
            publish: {
                active: { value: false, reflect: true },
            },
            file: null,
            diff: null,
            highlightData: null,
            fileChanged: function(oldValue, newValue) {
                var output = this.$.output;
                output.innerHTML = "";
            },
            handleTap: function(event) {
                var element = event.target;
                if (!element.classList.contains("line-number"))
                    return;
                var row = element.parentNode;
                if (row.classList.contains("header"))
                    return;
                if (!row.nextSibling || !row.nextSibling.classList.contains("messages")) {
                    var messages = document.createElement("div");
                    messages.className = "messages";
                    row.parentNode.insertBefore(messages, row.nextSibling);
                }
                var messages = toArray(row.nextSibling.querySelectorAll("cr-patch-file-message"));
                var existingDraft = messages.find(function(fileMessage) {
                    return !fileMessage.message.date;
                });
                if (existingDraft) {
                    existingDraft.focusInput();
                    return;
                }
                var numbers = row.querySelectorAll(".line-number");
                var message = PatchFileMessage.createDraft();
                if (row.classList.contains("remove")) {
                    message.line = numbers[0].textContent.toNumber();
                    message.left = true;
                } else {
                    message.line = numbers[1].textContent.toNumber();
                }
                var fileMessage = document.createElement("cr-patch-file-message");
                fileMessage.message = message;
                fileMessage.expanded = true;
                row.nextSibling.appendChild(fileMessage);
            },
            saveDraft: function(event) {
                var self = this;
                var message = event.detail.message;
                var text = event.detail.text;
                var target = event.target;
                this.fire("butterbar-update", {
                    message: "Saving..."
                });
                this.file.saveDraft(message, text).then(function() {
                    self.fire("butterbar-update");
                    target.expanded = false;
                }).catch(function(e) {
                    self.fire("butterbar-update");
                    console.log(e);
                });
            },
            cancelDraft: function(event) {
                var message = event.detail.message;
                var target = event.target;
                if (!message.date)
                    target.remove();
            },
            discardDraft: function(event) {
                var self = this;
                var message = event.detail.message;
                var target = event.target;
                this.fire("butterbar-update", {
                    message: "Saving..."
                });
                this.file.discardDraft(message).then(function() {
                    self.fire("butterbar-update");
                    self.file.removeMessage(message);
                    target.remove();
                }).catch(function(e) {
                    self.fire("butterbar-update");
                    console.log(e);
                });
            },
            showDiff: function() {
                if (this.active)
                    return Promise.resolve(this);
                this.active = true;
                if (!this.diff) {
                    var self = this;
                    return this.file.loadDiff().then(function(diff) {
                        self.diff = diff;
                        return self.createDiffAsync();
                    }).catch(function(e) {
                        this.active = false;
                        console.log(e);
                    });
                }
                return this.createDiffAsync();
            },
            hideDiff: function() {
                if (!this.active)
                    return Promise.resolve(this);
                this.active = false;
                this.$.output.innerHTML = "";
                return Promise.resolve(this);
            },
            toggleDiff: function() {
                return this.active ? this.hideDiff() : this.showDiff();
            },
            createDiffAsync: function() {
                return new Promise(function(fulfill, reject) {
                    this.async(function() {
                        this.createDiff();
                        fulfill();
                    }, null, 1);
                }.bind(this));
            },
            createDiff: function() {
                if (!this.active)
                    return;
                var output = this.$.output;
                var file = this.file;
                var language = file.language;
                var self = this;
                if (this.diff.isImage) {
                    var image = document.createElement("cr-diff-image");
                    image.file = file;
                    output.appendChild(image);
                    return;
                }
                if (this.diff.from) {
                    var section = document.createElement("div");
                    output.appendChild(section);
                    this.emitLine(section, {
                        type: "header",
                        beforeNumber: 0,
                        afterNumber: 0,
                        contextLinesStart: 0,
                        contextLinesEnd: 0,
                        context: false,
                        text: this.diff.from,
                    });
                }
                this.diff.groups.forEach(function(group) {
                    var section = document.createElement("div");
                    output.appendChild(section);

                    group.forEach(function(line) {
                        if (language != file.language && file.shouldResetEmbeddedLanguage(language, line.text)) {
                            language = file.language;
                            self.highlightData = null;
                        }
                        self.emitLine(section, line, language);
                        if (language == file.language) {
                            language = file.selectEmbeddedLanguage(line.text);
                            if (language != file.language)
                                self.highlightData = null;
                        }
                    });
                });
            },
            emitLine: function(section, line, language) {
                var self = this;
                var file = this.file;

                var row = document.createElement("div");
                row.className = "row " + line.type;
                section.appendChild(row);

                var beforeMessages;
                var before = row.appendChild(document.createElement("div"));
                before.className = "line-number";
                if (line.type == "both" || line.type == "remove") {
                    beforeMessages = file.messages[line.beforeNumber];
                    before.textContent = line.beforeNumber;
                } else if (line.type == "header") {
                    before.textContent = "@@";
                }
                row.appendChild(before);

                var afterMessages;
                var after = row.appendChild(document.createElement("div"));
                after.className = "line-number";
                if (line.type == "both" || line.type == "add") {
                    afterMessages = file.messages[line.afterNumber];
                    after.textContent = line.afterNumber;
                } else if (line.type == "header") {
                    after.textContent = "@@";
                }
                row.appendChild(after);

                var text = row.appendChild(document.createElement("div"));
                text.className = "text";
                if (language) {
                    try {
                        var code = hljs.highlight(language, line.text, true, self.highlightData);
                        self.highlightData = code.top;
                        text.innerHTML = code.value;
                    } catch (e) {
                        console.log("Syntax highlighter error", e);
                        text.textContent = line.text;
                    }
                } else {
                    text.textContent = line.text;
                }
                row.appendChild(text);

                if (line.context) {
                    var action = row.appendChild(document.createElement("cr-action"));
                    action.textContent = "Show context";
                    action.onclick = function() {
                        file.loadContext(line.contextLinesStart, line.contextLinesEnd).then(function(lines) {
                            section.innerHTML = "";
                            lines.forEach(function(line) {
                                self.emitLine(section, line, language);
                            });
                        }).catch(function(e) {
                            console.log(e);
                        });
                    };
                }

                if (!beforeMessages && !afterMessages)
                    return;

                var messages = document.createElement("div");
                messages.className = "messages";

                if (beforeMessages) {
                    beforeMessages.forEach(function(message) {
                        if (!message.left)
                            return;
                        var fileMessage = document.createElement("cr-patch-file-message");
                        fileMessage.message = message;
                        messages.appendChild(fileMessage);
                    });
                }

                if (afterMessages) {
                    afterMessages.forEach(function(message) {
                        if (message.left)
                            return;
                        var fileMessage = document.createElement("cr-patch-file-message");
                        fileMessage.message = message;
                        messages.appendChild(fileMessage);
                    });
                }

                if (messages.firstChild)
                    section.appendChild(messages);
            },
        });
    </script>
</ploymer-element>
